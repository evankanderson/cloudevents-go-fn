#!/usr/bin/env bash
set -eo pipefail

echo "CloudEvents Go Function Buildpack"

# INPUT ARGUMENTS
layers_dir="$1"
platform_dir="$2"
env_dir="${platform_dir}/env"
plan_path="$3"

# Extract the package name from the plan.
PACKAGE=$(cat ${plan_path} | \
	      yj -tj | \
	      jq -r '.entries | map(select(.name=="ce-go-function")) | .[0].metadata.package')
FUNCTION=$(cat ${plan_path} | \
	      yj -tj | \
	      jq -r '.entries | map(select(.name=="ce-go-function")) | .[0].metadata.function')
PROTOCOL=$(cat ${plan_path} | \
	      yj -tj | \
	      jq -r '.entries | map(select(.name=="ce-go-function")) | .[0].metadata.protocol')

echo "  Package  -> ${PACKAGE}"
echo "  Function -> ${FUNCTION}"
echo "  Protocol -> ${PROTOCOL}"

mkdir -p ./ce-cmd/function
cat > ./ce-cmd/function/main.go <<EOF
package main

import (
	"context"
	"log"

        p "${PACKAGE}"
)

func main() {
	client, err := newClient()
	if err != nil {
		log.Fatal(err.Error())
	}

	if err := client.StartReceiver(context.Background(), p.${FUNCTION}); err != nil {
		log.Fatal(err)
	}
}

EOF

cat > ./ce-cmd/function/http.go <<EOF
// +build http

package main

import (
	cloudevents "github.com/cloudevents/sdk-go/v2"
)

func newClient() (cloudevents.Client, error) {
	return cloudevents.NewDefaultClient()
}

EOF


LAYER="${layers_dir}/${RANDOM}"
# Designate this layer as a "build layer"
cat > "${LAYER}.toml" <<EOF
build = true
EOF
# Add an environment variable for subsequent steps.
mkdir -p "${LAYER}/env.build"
echo -n ./ce-cmd/function > "${LAYER}/env.build/BP_GO_TARGETS.override"
echo -n -tags=${PROTOCOL} > "${LAYER}/env.build/GOFLAGS.append"

echo
